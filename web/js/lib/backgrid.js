// Libs: Backgrid + backbone-pageable
"use strict";

// backbone-pageable 1.3.0 (w/o commonjs and amd)
// http://github.com/wyuenho/backbone-pageable
// Copyright (c) 2013 Jimmy Yuen Ho Wong
// Licensed under the MIT @license.
!function(e){if("undefined"!=typeof _&&"undefined"!=typeof Backbone){var t=Backbone.PageableCollection,r=Backbone.PageableCollection=e(_,Backbone);Backbone.PageableCollection.noConflict=function(){return Backbone.PageableCollection=t,r}}}(function(e,t){function r(t,r){if(!e.isNumber(t)||e.isNaN(t)||!e.isFinite(t)||~~t!==t)throw new TypeError("`"+r+"` must be a finite integer");return t}function s(e){for(var t,r,s,a,i={},n=decodeURIComponent,o=e.split("&"),l=0,c=o.length;c>l;l++){var u=o[l];t=u.split("="),r=t[0],s=t[1]||!0,r=n(r),a=i[r],d(a)?a.push(s):i[r]=a?[a,s]:s}return i}var a=e.extend,i=e.omit,n=e.clone,o=e.each,l=e.pick,c=e.contains,u=e.isEmpty,h=e.pairs,f=e.invert,d=e.isArray,g=e.isFunction,P=e.isObject,v=e.keys,p=e.isUndefined,m=e.result,k=Math.ceil,y=Math.floor,b=Math.max,S=t.Collection.prototype,_=/[\s'"]/g,C=/[<>\s'"]/g,R=t.Collection.extend({state:{firstPage:1,lastPage:null,currentPage:null,pageSize:25,totalPages:null,totalRecords:null,sortKey:null,order:-1},mode:"server",queryParams:{currentPage:"page",pageSize:"per_page",totalPages:"total_pages",totalRecords:"total_entries",sortKey:"sort_by",order:"order",directions:{"-1":"asc",1:"desc"}},constructor:function(e,r){t.Collection.apply(this,arguments),r=r||{};var s=this.mode=r.mode||this.mode||x.mode,i=a({},x.queryParams,this.queryParams,r.queryParams||{});i.directions=a({},x.queryParams.directions,this.queryParams.directions,i.directions||{}),this.queryParams=i;var o=this.state=a({},x.state,this.state,r.state||{});o.currentPage=null==o.currentPage?o.firstPage:o.currentPage,d(e)||(e=e?[e]:[]),"server"==s||null!=o.totalRecords||u(e)||(o.totalRecords=e.length),this.switchMode(s,a({fetch:!1,resetState:!1,models:e},r));var l=r.comparator;if(o.sortKey&&!l&&this.setSorting(o.sortKey,o.order,r),"server"!=s){var c=this.fullCollection;l&&r.full&&(delete this.comparator,c.comparator=l),r.full&&c.sort(),e&&!u(e)&&(this.getPage(o.currentPage),e.splice.apply(e,[0,e.length].concat(this.models)))}this._initState=n(this.state)},_makeFullCollection:function(e,r){var s,a,i,n=["url","model","sync","comparator"],o=this.constructor.prototype,l={};for(s=0,a=n.length;a>s;s++)i=n[s],p(o[i])||(l[i]=o[i]);var c=new(t.Collection.extend(l))(e,r);for(s=0,a=n.length;a>s;s++)i=n[s],this[i]!==o[i]&&(c[i]=this[i]);return c},_makeCollectionEventHandler:function(e,t){return function(r,s,i,l){var c=e._handlers;o(v(c),function(r){var s=c[r];e.off(r,s),t.off(r,s)});var u=n(e.state),h=u.firstPage,f=0===h?u.currentPage:u.currentPage-1,d=u.pageSize,g=f*d,P=g+d;if("add"==r){var m,y,b,S,l=l||{};if(i==t)y=t.indexOf(s),y>=g&&P>y&&(S=e,m=b=y-g);else{m=e.indexOf(s),y=g+m,S=t;var b=p(l.at)?y:l.at+g}if(++u.totalRecords,e.state=e._checkState(u),S){S.add(s,a({},l||{},{at:b}));var _=m>=d?s:!p(l.at)&&P>b&&e.length>d?e.at(d):null;if(_){var C=i._events.add||[],R={onAdd:!0};if(C.length){var x=C[C.length-1],w=x.callback;x.callback=function(){try{w.apply(this,arguments),e.remove(_,R)}finally{x.callback=w}}}else e.remove(_,R)}}}if("remove"==r)if(l.onAdd)delete l.onAdd;else{if(--u.totalRecords){var q=u.totalPages=k(u.totalRecords/d);u.lastPage=0===h?q-1:q,u.currentPage>q&&(u.currentPage=u.lastPage)}else u.totalRecords=null,u.totalPages=null;e.state=e._checkState(u);var z,E=l.index;i==e?((z=t.at(P))&&e.push(z),t.remove(s)):E>=g&&P>E&&(e.remove(s),z=t.at(f*(d+E)),z&&e.push(z))}if("reset"==r)if(l=i,i=s,i===e&&null==l.from&&null==l.to){var K=t.models.slice(0,g),B=t.models.slice(g+e.models.length);t.reset(K.concat(e.models).concat(B),l)}else i===t&&((u.totalRecords=t.models.length)||(u.totalRecords=null,u.totalPages=null),"client"==e.mode&&(u.lastPage=u.currentPage=u.firstPage),e.state=e._checkState(u),e.reset(t.models.slice(g,P),a({},l,{parse:!1})));"sort"==r&&(l=i,i=s,i===t&&e.reset(t.models.slice(g,P),a({},l,{parse:!1}))),o(v(c),function(r){var s=c[r];o([e,t],function(e){e.on(r,s);var t=e._events[r]||[];t.unshift(t.pop())})})}},_checkState:function(e){var t=this.mode,s=this.links,a=e.totalRecords,i=e.pageSize,n=e.currentPage,o=e.firstPage,l=e.totalPages;if(null!=a&&null!=i&&null!=n&&null!=o&&("infinite"==t?s:!0)){if(a=r(a,"totalRecords"),i=r(i,"pageSize"),n=r(n,"currentPage"),o=r(o,"firstPage"),1>i)throw new RangeError("`pageSize` must be >= 1");if(l=e.totalPages=k(a/i),0>o||o>1)throw new RangeError("`firstPage must be 0 or 1`");if(e.lastPage=0===o?b(0,l-1):l,"infinite"==t){if(!s[n+""])throw new RangeError("No link found for page "+n)}else if(o>n||l>0&&(o?n>l:n>=l))throw new RangeError("`currentPage` must be firstPage <= currentPage "+(o?">":">=")+" totalPages if "+o+"-based. Got "+n+".")}return e},setPageSize:function(e,t){return e=r(e,"pageSize"),t=t||{},this.state=this._checkState(a({},this.state,{pageSize:e,totalPages:k(this.state.totalRecords/e)})),this.getPage(this.state.currentPage,t)},switchMode:function(t,r){if(!c(["server","client","infinite"],t))throw new TypeError('`mode` must be one of "server", "client" or "infinite"');r=r||{fetch:!0,resetState:!0};var s=this.state=r.resetState?n(this._initState):this._checkState(a({},this.state));this.mode=t;var l,u=this,h=this.fullCollection,f=this._handlers=this._handlers||{};if("server"==t||h)"server"==t&&h&&(o(v(f),function(e){l=f[e],u.off(e,l),h.off(e,l)}),delete this._handlers,this._fullComparator=h.comparator,delete this.fullCollection);else{h=this._makeFullCollection(r.models||[]),h.pageableCollection=this,this.fullCollection=h;var d=this._makeCollectionEventHandler(this,h);o(["add","remove","reset","sort"],function(t){f[t]=l=e.bind(d,{},t),u.on(t,l),h.on(t,l)}),h.comparator=this._fullComparator}if("infinite"==t)for(var g=this.links={},P=s.firstPage,p=k(s.totalRecords/s.pageSize),m=0===P?b(0,p-1):p||P,y=s.firstPage;m>=y;y++)g[y]=this.url;else this.links&&delete this.links;return r.fetch?this.fetch(i(r,"fetch","resetState")):this},hasPrevious:function(){var e=this.state,t=e.currentPage;return"infinite"!=this.mode?t>e.firstPage:!!this.links[t-1]},hasNext:function(){var e=this.state,t=this.state.currentPage;return"infinite"!=this.mode?t<e.lastPage:!!this.links[t+1]},getFirstPage:function(e){return this.getPage("first",e)},getPreviousPage:function(e){return this.getPage("prev",e)},getNextPage:function(e){return this.getPage("next",e)},getLastPage:function(e){return this.getPage("last",e)},getPage:function(e,t){var s=this.mode,n=this.fullCollection;t=t||{fetch:!1};var o=this.state,l=o.firstPage,c=o.currentPage,h=o.lastPage,f=o.pageSize,d=e;switch(e){case"first":d=l;break;case"prev":d=c-1;break;case"next":d=c+1;break;case"last":d=h;break;default:d=r(e,"index")}this.state=this._checkState(a({},o,{currentPage:d})),t.from=c,t.to=d;var g=(0===l?d:d-1)*f,P=n&&n.length?n.models.slice(g,g+f):[];return"client"!=s&&("infinite"!=s||u(P))||t.fetch?("infinite"==s&&(t.url=this.links[d]),this.fetch(i(t,"fetch"))):this.reset(P,i(t,"fetch"))},getPageByOffset:function(e,t){if(0>e)throw new RangeError("`offset must be > 0`");e=r(e);var s=y(e/this.state.pageSize);return 0!==this.state.firstPage&&s++,s>this.state.lastPage&&(s=this.state.lastPage),this.getPage(s,t)},sync:function(e,r,s){var i=this;if("infinite"==i.mode){var n=s.success,o=i.state.currentPage;s.success=function(e,t,r){var l=i.links,c=i.parseLinks(e,a({xhr:r},s));c.first&&(l[i.state.firstPage]=c.first),c.prev&&(l[o-1]=c.prev),c.next&&(l[o+1]=c.next),n&&n(e,t,r)}}return(S.sync||t.sync).call(i,e,r,s)},parseLinks:function(e,t){var r={},a=t.xhr.getResponseHeader("Link");if(a){var i=["first","prev","previous","next","last"];o(a.split(","),function(e){var t=e.split(";"),s=t[0].replace(C,""),a=t.slice(1);o(a,function(e){var t=e.split("="),a=t[0].replace(_,""),n=t[1].replace(_,"");"rel"==a&&c(i,n)&&("previous"==n?r.prev=s:r[n]=s)})});var l,u,h=r.last||"";if(u=(l=h.indexOf("?"))?h.slice(l+1):""){var f=s(u),d=n(this.state),g=this.queryParams,P=d.pageSize,v=1*f[g.totalRecords],p=1*f[g.currentPage],m=f[g.totalPages];v||(p?v=(0===d.firstPage?p+1:p)*P:m&&(v=m*P)),v&&(d.totalRecords=v),this.state=this._checkState(d)}}return delete r.last,r},parse:function(e){var t=this.parseState(e,n(this.queryParams),n(this.state));return t&&(this.state=this._checkState(a({},this.state,t))),this.parseRecords(e)},parseState:function(t,r,s){if(t&&2===t.length&&P(t[0])&&d(t[1])){var a=n(s),l=t[0];return o(h(i(r,"directions")),function(t){var r=t[0],s=t[1],i=l[s];p(i)||e.isNull(i)||(a[r]=l[s])}),l.order&&(a.order=1*f(r.directions)[l.order]),a}},parseRecords:function(e){return e&&2===e.length&&P(e[0])&&d(e[1])?e[1]:e},fetch:function(e){e=e||{};var t=this._checkState(this.state),r=this.mode;"infinite"!=r||e.url||(e.url=this.links[t.currentPage]);var o=e.data||{},c=m(e,"url")||m(this,"url")||"",u=c.indexOf("?");-1!=u&&(a(o,s(c.slice(u+1))),c=c.slice(0,u)),e.url=c,e.data=o;var f,d,P,k,y="client"==this.mode?l(this.queryParams,"sortKey","order"):i(l(this.queryParams,v(x.queryParams)),"directions"),b=h(y),_=n(this);for(f=0;f<b.length;f++)d=b[f],P=d[0],k=d[1],k=g(k)?k.call(_):k,null!=t[P]&&null!=k&&(o[k]=t[P]);t.sortKey&&t.order?o[y.order]=this.queryParams.directions[t.order+""]:t.sortKey||delete o[y.order];var C=h(i(this.queryParams,v(x.queryParams)));for(f=0;f<C.length;f++)d=C[f],k=d[1],k=g(k)?k.call(_):k,o[d[0]]=k;var R=this.fullCollection,w=this.links;if("server"!=r){var q=this,z=e.success;return e.success=function(s,i,n){n=n||{},p(e.silent)?delete n.silent:n.silent=e.silent;var o=s.models,l=t.currentPage;if("client"==r)R.reset(o,n);else if(w[l]){var c=t.pageSize,u=(0===t.firstPage?l:l-1)*c,h=R.models,f=h.slice(0,u),d=h.slice(u+c);h=f.concat(o).concat(d);var g=R.set||R.update;g.call(R,h,a({silent:!0},n)),R.trigger("reset",R,n)}else R.add(o,a({at:R.length},n));z&&z(s,i,n)},S.fetch.call(q,a({},e,{silent:!0}))}return S.fetch.call(this,e)},_makeComparator:function(e,t){var r=this.state;return e=e||r.sortKey,t=t||r.order,e&&t?function(r,s){var a,i=r.get(e),n=s.get(e);return 1===t&&(a=i,i=n,n=a),i===n?0:n>i?-1:1}:void 0},setSorting:function(e,t,r){var s=this.state;s.sortKey=e,s.order=t=t||s.order;var i=this.fullCollection,n=!1,o=!1;e||(n=o=!0);var l=this.mode;r=a({side:"client"==l?l:"server",full:!0},r);var c=this._makeComparator(e,t),u=r.full,h=r.side;return"client"==h?u?(i&&(i.comparator=c),n=!0):(this.comparator=c,o=!0):"server"!=h||u||(this.comparator=c),n&&delete this.comparator,o&&i&&delete i.comparator,this}}),x=R.prototype;return R});

// backgrid 0.2.6
// http://github.com/wyuenho/backgrid
// Copyright (c) 2013 Jimmy Yuen Ho Wong and contributors
// Licensed under the MIT @license.
(function(e,t,i,n){function r(e){return String.fromCharCode(e.charCodeAt(0)-32)+e.slice(1)}function o(e,t,i){var n=t-(e+"").length;n=0>n?0:n;for(var r="",o=0;n>o;o++)r+=i;return r+e}var s="	\n\f\r   ᠎             　\u2028\u2029﻿";if(!String.prototype.trim||s.trim()){s="["+s+"]";var l=new RegExp("^"+s+s+"*"),a=new RegExp(s+s+"*$");String.prototype.trim=function(){if(void 0===this||null===this)throw new TypeError("can't convert "+this+" to object");return String(this).replace(l,"").replace(a,"")}}var h=e.Backgrid={VERSION:"0.2.6",Extension:{},requireOptions:function(e,t){for(var n=0;n<t.length;n++){var r=t[n];if(i.isUndefined(e[r]))throw new TypeError("'"+r+"' is required")}},resolveNameToClass:function(e,t){if(i.isString(e)){var n=i.map(e.split("-"),function(e){return r(e)}).join("")+t,o=h[n]||h.Extension[n];if(i.isUndefined(o))throw new ReferenceError("Class '"+n+"' not found");return o}return e}};i.extend(h,n.Events);var c=h.Command=function(e){i.extend(this,{altKey:!!e.altKey,"char":e.char,charCode:e.charCode,ctrlKey:!!e.ctrlKey,key:e.key,keyCode:e.keyCode,locale:e.locale,location:e.location,metaKey:!!e.metaKey,repeat:!!e.repeat,shiftKey:!!e.shiftKey,which:e.which})};i.extend(c.prototype,{moveUp:function(){return this.keyCode==38},moveDown:function(){return this.keyCode===40},moveLeft:function(){return this.shiftKey&&this.keyCode===9},moveRight:function(){return!this.shiftKey&&this.keyCode===9},save:function(){return this.keyCode===13},cancel:function(){return this.keyCode===27},passThru:function(){return!(this.moveUp()||this.moveDown()||this.moveLeft()||this.moveRight()||this.save()||this.cancel())}});var d=h.CellFormatter=function(){};i.extend(d.prototype,{fromRaw:function(e){return e},toRaw:function(e){return e}});var u=h.NumberFormatter=function(e){if(e=e?i.clone(e):{},i.extend(this,this.defaults,e),this.decimals<0||this.decimals>20)throw new RangeError("decimals must be between 0 and 20")};u.prototype=new d,i.extend(u.prototype,{defaults:{decimals:2,decimalSeparator:".",orderSeparator:","},HUMANIZED_NUM_RE:/(\d)(?=(?:\d{3})+$)/g,fromRaw:function(e){if(i.isNull(e)||i.isUndefined(e))return"";e=e.toFixed(~~this.decimals);var t=e.split("."),n=t[0],r=t[1]?(this.decimalSeparator||".")+t[1]:"";return n.replace(this.HUMANIZED_NUM_RE,"$1"+this.orderSeparator)+r},toRaw:function(e){for(var t="",n=e.trim().split(this.orderSeparator),r=0;r<n.length;r++)t+=n[r];var o=t.split(this.decimalSeparator);t="";for(var r=0;r<o.length;r++)t=t+o[r]+".";t[t.length-1]==="."&&(t=t.slice(0,t.length-1));var s=(1*t).toFixed(~~this.decimals)*1;return i.isNumber(s)&&!i.isNaN(s)?s:void 0}});var m=h.DatetimeFormatter=function(e){if(e=e?i.clone(e):{},i.extend(this,this.defaults,e),!this.includeDate&&!this.includeTime)throw new Error("Either includeDate or includeTime must be true")};m.prototype=new d,i.extend(m.prototype,{defaults:{includeDate:!0,includeTime:!0,includeMilli:!1},DATE_RE:/^([+\-]?\d{4})-(\d{2})-(\d{2})$/,TIME_RE:/^(\d{2}):(\d{2}):(\d{2})(\.(\d{3}))?$/,ISO_SPLITTER_RE:/T|Z| +/,_convert:function(e,t){var n,r=null;if(i.isNumber(e)){var s=new Date(e);n=o(s.getUTCFullYear(),4,0)+"-"+o(s.getUTCMonth()+1,2,0)+"-"+o(s.getUTCDate(),2,0),r=o(s.getUTCHours(),2,0)+":"+o(s.getUTCMinutes(),2,0)+":"+o(s.getUTCSeconds(),2,0)}else{e=e.trim();var l=e.split(this.ISO_SPLITTER_RE)||[];n=this.DATE_RE.test(l[0])?l[0]:"",r=n&&l[1]?l[1]:this.TIME_RE.test(l[0])?l[0]:""}var a=this.DATE_RE.exec(n)||[],h=this.TIME_RE.exec(r)||[];if(t){if(this.includeDate&&i.isUndefined(a[0]))return;if(this.includeTime&&i.isUndefined(h[0]))return;if(!this.includeDate&&n)return;if(!this.includeTime&&r)return}var s=new Date(Date.UTC(a[1]*1||0,a[2]*1-1||0,a[3]*1||0,h[1]*1||null,h[2]*1||null,h[3]*1||null,h[5]*1||null)),c="";return this.includeDate&&(c=o(s.getUTCFullYear(),4,0)+"-"+o(s.getUTCMonth()+1,2,0)+"-"+o(s.getUTCDate(),2,0)),this.includeTime&&(c=c+(this.includeDate?"T":"")+o(s.getUTCHours(),2,0)+":"+o(s.getUTCMinutes(),2,0)+":"+o(s.getUTCSeconds(),2,0),this.includeMilli&&(c=c+"."+o(s.getUTCMilliseconds(),3,0))),this.includeDate&&this.includeTime&&(c+="Z"),c},fromRaw:function(e){return i.isNull(e)||i.isUndefined(e)?"":this._convert(e)},toRaw:function(e){return this._convert(e,!0)}});var p=h.StringFormatter=function(){};p.prototype=new d,i.extend(p.prototype,{fromRaw:function(e){return i.isUndefined(e)||i.isNull(e)?"":e+""}});var f=h.EmailFormatter=function(){};f.prototype=new d,i.extend(f.prototype,{toRaw:function(e){var t=e.trim().split("@");return t.length===2&&i.all(t)?e:void 0}});var v=h.SelectFormatter=function(){};v.prototype=new d,i.extend(v.prototype,{fromRaw:function(e){return i.isArray(e)?e:null!=e?[e]:[]}});var g=h.CellEditor=n.View.extend({initialize:function(e){h.requireOptions(e,["formatter","column","model"]),this.formatter=e.formatter,this.column=e.column,this.column instanceof R||(this.column=new R(this.column)),this.listenTo(this.model,"backgrid:editing",this.postRender)},postRender:function(e,t){return(null==t||t.get("name")==this.column.get("name"))&&this.$el.focus(),this}}),w=h.InputCellEditor=g.extend({tagName:"input",attributes:{type:"text"},events:{blur:"saveOrCancel",keydown:"saveOrCancel"},initialize:function(e){g.prototype.initialize.apply(this,arguments),e.placeholder&&this.$el.attr("placeholder",e.placeholder)},render:function(){return this.$el.val(this.formatter.fromRaw(this.model.get(this.column.get("name")))),this},saveOrCancel:function(e){var t=this.formatter,n=this.model,r=this.column,o=new c(e),s=e.type==="blur";if(o.moveUp()||o.moveDown()||o.moveLeft()||o.moveRight()||o.save()||s){e.preventDefault(),e.stopPropagation();var l=this.$el.val(),a=t.toRaw(l);i.isUndefined(a)?n.trigger("backgrid:error",n,r,l):(n.set(r.get("name"),a),n.trigger("backgrid:edited",n,r,o))}else o.cancel()&&(e.stopPropagation(),n.trigger("backgrid:edited",n,r,o))},postRender:function(e,t){if(null==t||t.get("name")==this.column.get("name"))if(this.$el.css("text-align")==="right"){var i=this.$el.val();this.$el.focus().val(null).val(i)}else this.$el.focus();return this}}),y=h.Cell=n.View.extend({tagName:"td",formatter:new d,editor:w,events:{click:"enterEditMode"},initialize:function(e){h.requireOptions(e,["model","column"]),this.column=e.column,this.column instanceof R||(this.column=new R(this.column)),this.formatter=h.resolveNameToClass(this.column.get("formatter")||this.formatter,"Formatter"),this.editor=h.resolveNameToClass(this.editor,"CellEditor"),this.listenTo(this.model,"change:"+this.column.get("name"),function(){this.$el.hasClass("editor")||this.render()}),this.listenTo(this.model,"backgrid:error",this.renderError)},render:function(){return this.$el.empty(),this.$el.text(this.formatter.fromRaw(this.model.get(this.column.get("name")))),this.delegateEvents(),this},enterEditMode:function(){var e=this.model,t=this.column;t.get("editable")&&(this.currentEditor=new this.editor({column:this.column,model:this.model,formatter:this.formatter}),e.trigger("backgrid:edit",e,t,this,this.currentEditor),this.undelegateEvents(),this.$el.empty(),this.$el.append(this.currentEditor.$el),this.currentEditor.render(),this.$el.addClass("editor"),e.trigger("backgrid:editing",e,t,this,this.currentEditor))},renderError:function(e,t){(null==t||t.get("name")==this.column.get("name"))&&this.$el.addClass("error")},exitEditMode:function(){this.$el.removeClass("error"),this.currentEditor.remove(),this.stopListening(this.currentEditor),delete this.currentEditor,this.$el.removeClass("editor"),this.render()},remove:function(){return this.currentEditor&&(this.currentEditor.remove.apply(this,arguments),delete this.currentEditor),n.View.prototype.remove.apply(this,arguments)}}),C=h.StringCell=y.extend({className:"string-cell",formatter:new p});h.UriCell=y.extend({className:"uri-cell",render:function(){this.$el.empty();var e=this.formatter.fromRaw(this.model.get(this.column.get("name")));return this.$el.append(t("<a>",{tabIndex:-1,href:e,title:e,target:"_blank"}).text(e)),this.delegateEvents(),this}}),h.EmailCell=C.extend({className:"email-cell",formatter:new f,render:function(){this.$el.empty();var e=this.formatter.fromRaw(this.model.get(this.column.get("name")));return this.$el.append(t("<a>",{tabIndex:-1,href:"mailto:"+e,title:e}).text(e)),this.delegateEvents(),this}});var b=h.NumberCell=y.extend({className:"number-cell",decimals:u.prototype.defaults.decimals,decimalSeparator:u.prototype.defaults.decimalSeparator,orderSeparator:u.prototype.defaults.orderSeparator,formatter:u,initialize:function(){y.prototype.initialize.apply(this,arguments),this.formatter=new this.formatter({decimals:this.decimals,decimalSeparator:this.decimalSeparator,orderSeparator:this.orderSeparator})}});h.IntegerCell=b.extend({className:"integer-cell",decimals:0});var x=h.DatetimeCell=y.extend({className:"datetime-cell",includeDate:m.prototype.defaults.includeDate,includeTime:m.prototype.defaults.includeTime,includeMilli:m.prototype.defaults.includeMilli,formatter:m,initialize:function(){y.prototype.initialize.apply(this,arguments),this.formatter=new this.formatter({includeDate:this.includeDate,includeTime:this.includeTime,includeMilli:this.includeMilli});var e=this.includeDate?"YYYY-MM-DD":"";e+=this.includeDate&&this.includeTime?"T":"",e+=this.includeTime?"HH:mm:ss":"",e+=this.includeTime&&this.includeMilli?".SSS":"",this.editor=this.editor.extend({attributes:i.extend({},this.editor.prototype.attributes,this.editor.attributes,{placeholder:e})})}});h.DateCell=x.extend({className:"date-cell",includeTime:!1}),h.TimeCell=x.extend({className:"time-cell",includeDate:!1});var E=h.BooleanCellEditor=g.extend({tagName:"input",attributes:{tabIndex:-1,type:"checkbox"},events:{mousedown:function(){this.mouseDown=!0},blur:"enterOrExitEditMode",mouseup:function(){this.mouseDown=!1},change:"saveOrCancel",keydown:"saveOrCancel"},render:function(){var e=this.formatter.fromRaw(this.model.get(this.column.get("name")));return this.$el.prop("checked",e),this},enterOrExitEditMode:function(e){if(!this.mouseDown){var t=this.model;t.trigger("backgrid:edited",t,this.column,new c(e))}},saveOrCancel:function(e){var t=this.model,i=this.column,n=this.formatter,r=new c(e);if(r.passThru()&&e.type!="change")return!0;r.cancel()&&(e.stopPropagation(),t.trigger("backgrid:edited",t,i,r));var o=this.$el;if(r.save()||r.moveLeft()||r.moveRight()||r.moveUp()||r.moveDown()){e.preventDefault(),e.stopPropagation();var s=n.toRaw(o.prop("checked"));t.set(i.get("name"),s),t.trigger("backgrid:edited",t,i,r)}else if(e.type=="change"){var s=n.toRaw(o.prop("checked"));t.set(i.get("name"),s),o.focus()}}});h.BooleanCell=y.extend({className:"boolean-cell",editor:E,events:{click:"enterEditMode"},render:function(){return this.$el.empty(),this.$el.append(t("<input>",{tabIndex:-1,type:"checkbox",checked:this.formatter.fromRaw(this.model.get(this.column.get("name")))})),this.delegateEvents(),this}});var T=h.SelectCellEditor=g.extend({tagName:"select",events:{change:"save",blur:"close",keydown:"close"},template:i.template('<option value="<%- value %>" <%= selected ? \'selected="selected"\' : "" %>><%- text %></option>'),setOptionValues:function(e){this.optionValues=e},setMultiple:function(e){this.multiple=e,this.$el.prop("multiple",e)},_renderOptions:function(e,t){for(var i="",n=0;n<e.length;n++)i+=this.template({text:e[n][0],value:e[n][1],selected:t.indexOf(e[n][1])>-1});return i},render:function(){this.$el.empty();var e=i.result(this,"optionValues"),n=this.formatter.fromRaw(this.model.get(this.column.get("name")));if(!i.isArray(e))throw TypeError("optionValues must be an array");for(var r=null,o=null,r=null,s=null,l=null,a=0;a<e.length;a++){var r=e[a];if(i.isArray(r))o=r[0],r=r[1],this.$el.append(this.template({text:o,value:r,selected:n.indexOf(r)>-1}));else{if(!i.isObject(r))throw TypeError("optionValues elements must be a name-value pair or an object hash of { name: 'optgroup label', value: [option name-value pairs] }");s=r.name,l=t("<optgroup></optgroup>",{label:s}),l.append(this._renderOptions(r.values,n)),this.$el.append(l)}}return this.delegateEvents(),this},save:function(e){var t=this.model,i=this.column;t.set(i.get("name"),this.formatter.toRaw(this.$el.val())),t.trigger("backgrid:edited",t,i,new c(e))},close:function(e){var t=this.model,i=this.column,n=new c(e);n.cancel()?(e.stopPropagation(),t.trigger("backgrid:edited",t,i,new c(e))):(n.save()||n.moveLeft()||n.moveRight()||n.moveUp()||n.moveDown()||e.type=="blur")&&(e.preventDefault(),e.stopPropagation(),e.type=="blur"&&this.$el.find("option").length===1&&t.set(i.get("name"),this.formatter.toRaw(this.$el.val())),t.trigger("backgrid:edited",t,i,new c(e)))}});h.SelectCell=y.extend({className:"select-cell",editor:T,multiple:!1,formatter:new v,optionValues:void 0,delimiter:", ",initialize:function(){y.prototype.initialize.apply(this,arguments),h.requireOptions(this,["optionValues"]),this.listenTo(this.model,"backgrid:edit",function(e,t,i,n){t.get("name")==this.column.get("name")&&(n.setOptionValues(this.optionValues),n.setMultiple(this.multiple))})},render:function(){this.$el.empty();var e=this.optionValues,t=this.formatter.fromRaw(this.model.get(this.column.get("name"))),n=[];try{if(!i.isArray(e)||i.isEmpty(e))throw new TypeError;for(var r=0;r<t.length;r++)for(var o=t[r],s=0;s<e.length;s++){var l=e[s];if(i.isArray(l)){var a=l[0],l=l[1];l==o&&n.push(a)}else{if(!i.isObject(l))throw new TypeError;for(var h=l.values,c=0;c<h.length;c++){var d=h[c];d[1]==o&&n.push(d[0])}}}this.$el.append(n.join(this.delimiter))}catch(u){if(u instanceof TypeError)throw TypeError("'optionValues' must be of type {Array.<Array>|Array.<{name: string, values: Array.<Array>}>}");throw u}return this.delegateEvents(),this}});var R=h.Column=n.Model.extend({defaults:{name:void 0,label:void 0,sortable:!0,editable:!0,renderable:!0,formatter:void 0,cell:void 0,headerCell:void 0},initialize:function(e){h.requireOptions(e,["cell","name"]),this.has("label")||this.set({label:this.get("name")},{silent:!0});var t=h.resolveNameToClass(this.get("headerCell"),"HeaderCell"),i=h.resolveNameToClass(this.get("cell"),"Cell");this.set({cell:i,headerCell:t},{silent:!0})}}),$=h.Columns=n.Collection.extend({model:R}),k=h.Row=n.View.extend({tagName:"tr",requiredOptions:["columns","model"],initialize:function(e){h.requireOptions(e,this.requiredOptions);var t=this.columns=e.columns;t instanceof n.Collection||(t=this.columns=new $(t));for(var i=this.cells=[],r=0;r<t.length;r++)i.push(this.makeCell(t.at(r),e));this.listenTo(t,"change:renderable",function(e,t){for(var n=0;n<i.length;n++){var r=i[n];r.column.get("name")==e.get("name")&&(t?r.$el.show():r.$el.hide())}}),this.listenTo(t,"add",function(t,n){var r=n.indexOf(t),o=this.makeCell(t,e);i.splice(r,0,o),o.column.get("renderable")||o.$el.hide();var s=this.$el;0===r?s.prepend(o.render().$el):r===n.length-1?s.append(o.render().$el):s.children().eq(r).before(o.render().$el)}),this.listenTo(t,"remove",function(e,t,n){i[n.index].remove(),i.splice(n.index,1)})},makeCell:function(e){return new(e.get("cell"))({column:e,model:this.model})},render:function(){this.$el.empty();for(var e=document.createDocumentFragment(),t=0;t<this.cells.length;t++){var i=this.cells[t];e.appendChild(i.render().el),i.column.get("renderable")||i.$el.hide()}return this.el.appendChild(e),this.delegateEvents(),this},remove:function(){for(var e=0;e<this.cells.length;e++){var t=this.cells[e];t.remove.apply(t,arguments)}return n.View.prototype.remove.apply(this,arguments)}}),D=h.EmptyRow=n.View.extend({tagName:"tr",emptyText:null,initialize:function(e){h.requireOptions(e,["emptyText","columns"]),this.emptyText=e.emptyText,this.columns=e.columns},render:function(){this.$el.empty();var e=document.createElement("td");return e.setAttribute("colspan",this.columns.length),e.textContent=this.emptyText,this.el.setAttribute("class","empty"),this.el.appendChild(e),this}}),N=h.HeaderCell=n.View.extend({tagName:"th",events:{"click a":"onClick"},_direction:null,initialize:function(e){h.requireOptions(e,["column","collection"]),this.column=e.column,this.column instanceof R||(this.column=new R(this.column)),this.listenTo(this.collection,"backgrid:sort",this._resetCellDirection)},direction:function(e){return arguments.length&&(this._direction&&this.$el.removeClass(this._direction),e&&this.$el.addClass(e),this._direction=e),this._direction},_resetCellDirection:function(e,t,i,n){n==this.collection&&(e!==this.column.get("name")?this.direction(null):this.direction(t))},onClick:function(e){e.preventDefault();var t=this.column.get("name");this.column.get("sortable")&&(this.direction()==="ascending"?this.sort(t,"descending",function(e,i){var n=e.get(t),r=i.get(t);return n===r?0:n>r?-1:1}):this.direction()==="descending"?this.sort(t,null):this.sort(t,"ascending",function(e,i){var n=e.get(t),r=i.get(t);return n===r?0:r>n?-1:1}))},sort:function(e,t,i){i=i||this._cidComparator;var r=this.collection;if(n.PageableCollection&&r instanceof n.PageableCollection){var o;o="ascending"===t?-1:"descending"===t?1:null,r.setSorting(o?e:null,o),r.mode=="client"?(r.fullCollection.comparator||(r.fullCollection.comparator=i),r.fullCollection.sort()):r.fetch({reset:!0})}else r.comparator=i,r.sort();this.collection.trigger("backgrid:sort",e,t,i,this.collection)},_cidComparator:function(e,t){var n=e.cid,r=t.cid;if(!i.isUndefined(n)&&!i.isUndefined(r)){if(n=n.slice(1)*1,r=r.slice(1)*1,r>n)return-1;if(n>r)return 1}return 0},render:function(){this.$el.empty();var e=t("<a>").text(this.column.get("label")).append("<b class='sort-caret'></b>");return this.$el.append(e),this.delegateEvents(),this}});h.HeaderRow=h.Row.extend({requiredOptions:["columns","collection"],initialize:function(){h.Row.prototype.initialize.apply(this,arguments)},makeCell:function(e,t){var i=e.get("headerCell")||t.headerCell||N;return i=new i({column:e,collection:this.collection})}});var M=h.Header=n.View.extend({tagName:"thead",initialize:function(e){h.requireOptions(e,["columns","collection"]),this.columns=e.columns,this.columns instanceof n.Collection||(this.columns=new $(this.columns)),this.row=new h.HeaderRow({columns:this.columns,collection:this.collection})},render:function(){return this.$el.append(this.row.render().$el),this.delegateEvents(),this},remove:function(){return this.row.remove.apply(this.row,arguments),n.View.prototype.remove.apply(this,arguments)}}),O=h.Body=n.View.extend({tagName:"tbody",initialize:function(e){h.requireOptions(e,["columns","collection"]),this.columns=e.columns,this.columns instanceof n.Collection||(this.columns=new $(this.columns)),this.row=e.row||k,this.rows=this.collection.map(function(e){var t=new this.row({columns:this.columns,model:e});return t},this),this.emptyText=e.emptyText,this._unshiftEmptyRowMayBe();var t=this.collection;this.listenTo(t,"add",this.insertRow),this.listenTo(t,"remove",this.removeRow),this.listenTo(t,"sort",this.refresh),this.listenTo(t,"reset",this.refresh),this.listenTo(t,"backgrid:edited",this.moveToNextCell)},_unshiftEmptyRowMayBe:function(){this.rows.length===0&&this.emptyText!=null&&this.rows.unshift(new D({emptyText:this.emptyText,columns:this.columns}))},insertRow:function(e,t,r){if(this.rows[0]instanceof D&&this.rows.pop().remove(),!(t instanceof n.Collection||r))return this.collection.add(e,r=t),void 0;r=i.extend({render:!0},r||{});var o=new this.row({columns:this.columns,model:e}),s=t.indexOf(e);this.rows.splice(s,0,o);var l=this.$el,a=l.children(),h=o.render().$el;r.render&&(s>=a.length?l.append(h):a.eq(s).before(h))},removeRow:function(e,t,n){return n?((i.isUndefined(n.render)||n.render)&&this.rows[n.index].remove(),this.rows.splice(n.index,1),this._unshiftEmptyRowMayBe(),void 0):(this.collection.remove(e,n=t),this._unshiftEmptyRowMayBe(),void 0)},refresh:function(){for(var e=0;e<this.rows.length;e++)this.rows[e].remove();return this.rows=this.collection.map(function(e){var t=new this.row({columns:this.columns,model:e});return t},this),this._unshiftEmptyRowMayBe(),this.render(),this.collection.trigger("backgrid:refresh",this),this},render:function(){this.$el.empty();for(var e=document.createDocumentFragment(),t=0;t<this.rows.length;t++){var i=this.rows[t];e.appendChild(i.render().el)}return this.el.appendChild(e),this.delegateEvents(),this},remove:function(){for(var e=0;e<this.rows.length;e++){var t=this.rows[e];t.remove.apply(t,arguments)}return n.View.prototype.remove.apply(this,arguments)},moveToNextCell:function(e,t,i){var n=this.collection.indexOf(e),r=this.columns.indexOf(t);if(i.moveUp()||i.moveDown()||i.moveLeft()||i.moveRight()||i.save()){var o=this.columns.length,s=o*this.collection.length;if(i.moveUp()||i.moveDown()){var l=this.rows[n+(i.moveUp()?-1:1)];l&&l.cells[r].enterEditMode()}else if(i.moveLeft()||i.moveRight())for(var a=i.moveRight(),h=n*o+r+(a?1:-1);h>=0&&s>h;a?h++:h--){var c=~~(h/o),d=h-c*o,u=this.rows[c].cells[d];if(u.column.get("renderable")&&u.column.get("editable")){u.enterEditMode();break}}}this.rows[n].cells[r].exitEditMode()}});h.Footer=n.View.extend({tagName:"tfoot",initialize:function(e){h.requireOptions(e,["columns","collection"]),this.columns=e.columns,this.columns instanceof n.Collection||(this.columns=new h.Columns(this.columns))}}),h.Grid=n.View.extend({tagName:"table",className:"backgrid",header:M,body:O,footer:null,initialize:function(e){h.requireOptions(e,["columns","collection"]),e.columns instanceof n.Collection||(e.columns=new $(e.columns)),this.columns=e.columns;var t=i.omit(e,["el","id","attributes","className","tagName","events"]);this.header=e.header||this.header,this.header=new this.header(t),this.body=e.body||this.body,this.body=new this.body(t),this.footer=e.footer||this.footer,this.footer&&(this.footer=new this.footer(t)),this.listenTo(this.columns,"reset",function(){this.header=new(this.header.remove().constructor)(t),this.body=new(this.body.remove().constructor)(t),this.footer&&(this.footer=new(this.footer.remove().constructor)(t)),this.render()})},insertRow:function(e,t,i){return this.body.insertRow(e,t,i)},removeRow:function(e,t,i){return this.body.removeRow(e,t,i)},insertColumn:function(e,t){return t=t||{render:!0},this.columns.add(e,t),this},removeColumn:function(e,t){return this.columns.remove(e,t),this},render:function(){return this.$el.empty(),this.$el.append(this.header.render().$el),this.footer&&this.$el.append(this.footer.render().$el),this.$el.append(this.body.render().$el),this.delegateEvents(),this.trigger("backgrid:rendered",this),this},remove:function(){return this.header.remove.apply(this.header,arguments),this.body.remove.apply(this.body,arguments),this.footer&&this.footer.remove.apply(this.footer,arguments),n.View.prototype.remove.apply(this,arguments)}})})(this,jQuery,_,Backbone);
// backgrid-paginator
(function(e,t,a,s){s.Extension.Paginator=a.View.extend({className:"backgrid-paginator",windowSize:10,fastForwardHandleLabels:{first:"《",prev:"〈",next:"〉",last:"》"},template:t.template('<ul><% _.each(handles, function (handle) { %><li <% if (handle.className) { %>class="<%= handle.className %>"<% } %>><a href="#" <% if (handle.title) {%> title="<%= handle.title %>"<% } %>><%= handle.label %></a></li><% }); %></ul>'),events:{"click a":"changePage"},initialize:function(e){s.requireOptions(e,["collection"]);var t=this.collection,a=t.fullCollection;a?(this.listenTo(a,"add",this.render),this.listenTo(a,"remove",this.render),this.listenTo(a,"reset",this.render)):(this.listenTo(t,"add",this.render),this.listenTo(t,"remove",this.render),this.listenTo(t,"reset",this.render))},changePage:function(t){t.preventDefault();var a=e(t.target).parent();if(!a.hasClass("active")&&!a.hasClass("disabled")){var s=e(t.target).text(),i=this.fastForwardHandleLabels,l=this.collection;if(i)switch(s){case i.first:return l.getFirstPage(),void 0;case i.prev:return l.getPreviousPage(),void 0;case i.next:return l.getNextPage(),void 0;case i.last:return l.getLastPage(),void 0}var n=l.state,r=+s;l.getPage(n.firstPage===0?r-1:r)}},makeHandles:function(){var e=[],t=this.collection,a=t.state,s=a.firstPage,i=+a.lastPage;i=Math.max(0,s?i-1:i);var l=Math.max(a.currentPage,a.firstPage);l=s?l-1:l;var n=Math.floor(l/this.windowSize)*this.windowSize,r=Math.min(i+1,n+this.windowSize);if(t.mode!=="infinite")for(var d=n;r>d;d++)e.push({label:d+1,title:"No. "+(d+1),className:l===d?"active":void 0});var h=this.fastForwardHandleLabels;return h&&(h.prev&&e.unshift({label:h.prev,className:t.hasPrevious()?void 0:"disabled"}),h.first&&e.unshift({label:h.first,className:t.hasPrevious()?void 0:"disabled"}),h.next&&e.push({label:h.next,className:t.hasNext()?void 0:"disabled"}),h.last&&e.push({label:h.last,className:t.hasNext()?void 0:"disabled"})),e},render:function(){return this.$el.empty(),this.$el.append(this.template({handles:this.makeHandles()})),this.delegateEvents(),this}})})(jQuery,_,Backbone,Backgrid);
// backgrid-filter (w/o lunr)
(function(j,c,e,f){var g=f.Extension.ServerSideFilter=e.View.extend({tagName:"form",className:"backgrid-filter form-search",template:c.template('<div class="input-prepend input-append"><span class="add-on"><i class="icon-search"></i></span><input type="text" <% if (placeholder) { %> placeholder="<%- placeholder %>" <% } %> name="<%- name %>" /><span class="add-on"><a class="close" href="#">&times;</a></span></div>'),events:{"click .close":"clear",submit:"search"},name:"q",placeholder:null,initialize:function(a){f.requireOptions(a,["collection"]);e.View.prototype.initialize.apply(this,arguments);this.name=a.name||this.name;this.placeholder=a.placeholder||this.placeholder;var b=this.collection,d=this;e.PageableCollection&&(b instanceof e.PageableCollection&&"server"==b.mode)&&(b.queryParams[this.name]=function(){return d.$el.find("input[type=text]").val()})},search:function(a){a&&a.preventDefault();a={};a[this.name]=this.$el.find("input[type=text]").val();this.collection.fetch({data:a})},clear:function(a){a&&a.preventDefault();this.$("input[type=text]").val(null);this.collection.fetch()},render:function(){this.$el.empty().append(this.template({name:this.name,placeholder:this.placeholder,value:this.value}));this.delegateEvents();return this}});f.Extension.ClientSideFilter=g.extend({events:{"click .close":function(a){a.preventDefault();this.clear()},"change input[type=text]":"search","keyup input[type=text]":"search",submit:function(a){a.preventDefault();this.search()}},fields:null,wait:149,initialize:function(a){g.prototype.initialize.apply(this,arguments);this.fields=a.fields||this.fields;this.wait=a.wait||this.wait;this._debounceMethods(["search","clear"]);var b=this.collection,d=this.shadowCollection=b.clone();d.url=b.url;d.sync=b.sync;d.parse=b.parse;this.listenTo(b,"add",function(a,b,c){d.add(a,c)});this.listenTo(b,"remove",function(a,b,c){d.remove(a,c)});this.listenTo(b,"sort reset",function(a,b){b=c.extend({reindex:!0},b||{});b.reindex&&d.reset(a.models)})},_debounceMethods:function(a){c.isString(a)&&(a=[a]);this.undelegateEvents();for(var b=0,d=a.length;b<d;b++){var h=a[b];this[h]=c.debounce(this[h],this.wait)}this.delegateEvents()},makeMatcher:function(a){var b=RegExp(a.trim().split(/\W/).join("|"),"i");return function(a){for(var c=this.fields||a.keys(),e=0,f=c.length;e<f;e++)if(b.test(a.get(c[e])+""))return!0;return!1}},search:function(){var a=c.bind(this.makeMatcher(this.$("input[type=text]").val()),this);this.collection.reset(this.shadowCollection.filter(a),{reindex:!1})},clear:function(){this.$("input[type=text]").val(null);this.collection.reset(this.shadowCollection.models,{reindex:!1})}})})(jQuery,_,Backbone,Backgrid);
// backgrid-select-all
(function(e,t,i,n,o){var c=o.Extension.SelectRowCell=n.View.extend({className:"select-row-cell",tagName:"td",events:{"keydown :checkbox":"onKeydown","change :checkbox":"onChange","click :checkbox":"enterEditMode"},initialize:function(e){o.requireOptions(e,["model","column"]),this.column=e.column,this.column instanceof o.Column||(this.column=new o.Column(this.column)),this.listenTo(this.model,"backgrid:select",function(e,t){this.$el.find(":checkbox").prop("checked",t).change()})},enterEditMode:function(){this.$el.find(":checkbox").focus()},exitEditMode:function(){this.$el.find(":checkbox").blur()},onKeydown:function(e){var t=new o.Command(e);return t.passThru()?!0:(t.cancel()?(e.stopPropagation(),this.$el.find(":checkbox").blur()):(t.save()||t.moveLeft()||t.moveRight()||t.moveUp()||t.moveDown())&&(e.preventDefault(),e.stopPropagation(),this.model.trigger("backgrid:edited",this.model,this.column,t)),void 0)},onChange:function(e){this.model.trigger("backgrid:selected",this.model,t(e.target).prop("checked"))},render:function(){return this.$el.empty().append('<input tabindex="-1" type="checkbox" />'),this.delegateEvents(),this}}),l=o.Extension.SelectAllHeaderCell=c.extend({className:"select-all-header-cell",tagName:"th",initialize:function(e){o.requireOptions(e,["column","collection"]),this.column=e.column,this.column instanceof o.Column||(this.column=new o.Column(this.column));var t=this.collection,i=this.selectedModels={};this.listenTo(t,"backgrid:selected",function(e,t){t?i[e.id||e.cid]=e:(delete i[e.id||e.cid],this.$el.find(":checkbox").prop("checked",!1))}),this.listenTo(t,"remove",function(e){delete i[e.cid]}),this.listenTo(t,"backgrid:refresh",function(){this.$el.find(":checkbox").prop("checked",!1);for(var e=0;e<t.length;e++){var n=t.at(e);i[n.id||n.cid]&&n.trigger("backgrid:select",n,!0)}})},onChange:function(e){var i=t(e.target).prop("checked"),n=this.collection;n.each(function(e){e.trigger("backgrid:select",e,i)})}});o.Grid.prototype.getSelectedModels=function(){for(var e,t=this.header.row.cells,i=0,n=t.length;n>i;i++){var o=t[i];if(o instanceof l){e=o;break}}var c=[];if(e)for(var s in e.selectedModels)c.push(this.collection.get(s));return c}})(window,jQuery,_,Backbone,Backgrid);
