#!/bin/bash
cd "$(dirname "$(which $0)")" > /dev/null
function out {
    echo -e "$(tput bold)$(tput setaf 3)$1 $(tput setaf 7)-> $(tput setaf 4)$2$(tput sgr0)"
}

out 'js/lib/*' 'out/js/lib/*'
rm -rf out/js
mkdir -p out/js/lib/test
cp js/lib/*.js out/js/lib/
cp js/lib/test/*.js out/js/lib/test/

js="out/js/lib/bootstrap-wysiwyg.js"
uglifyjs $js -o $js -mc --screw-ie8

out 'js/models.coffee + js/console.coffee + js/manager.coffee + js/main.coffee' 'out/js/main.js'
coffee -pjc js/models.coffee js/console.coffee js/manager.coffee js/main.coffee \
 | uglifyjs - -o out/js/main.js -mc --screw-ie8

for coffee in js/*.coffee ; do
    [[ -f "$coffee" ]] || continue
    #[[ "$coffee" == "js/test_data.coffee" ]] && continue
    [[ "$coffee" == "js/manager.coffee" || "$coffee" == "js/models.coffee" || "$coffee" == "js/console.coffee" || "$coffee" == "js/main.coffee" ]] && continue
    js="out/js/$(basename -s .coffee $coffee).js"
    out "$coffee" "$js"
    coffee -cp "$coffee" | uglifyjs - -o "$js" -mc --screw-ie8
done

out 'css/console.less' 'out/css/console.css'
rm out/css/console.css
lessc --no-ie-compat --yui-compress -O2 css/console.less out/css/console.css

out 'index.jade + html/*' 'out/index.html'
rm out/index.html
jade -D -p . index.jade -o out/ > /dev/null

rm -rf out/img out/font
out 'img/*' 'out/img/*'
cp -r img out/
out 'font/*' 'out/font/*'
cp -r font out/

cd - > /dev/null
