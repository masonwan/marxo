!function(){"use strict";var t={}.hasOwnProperty,e=function(e,n){function i(){this.constructor=e}for(var o in n)t.call(n,o)&&(e[o]=n[o]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};define("workflow",["console","workflow_models","lib/jquery-ui","lib/jquery-jsplumb"],function(t,n){var i,o,r,s,l,a,c,u,p,h,d,f,_,y,m,v,g,w,b,k,E,C,z,L,S,N,x,T,V,P,M,j,D,B,F,I,O,H;return S=t.async,N=t.find,x=t.findAll,k=t.View,o=t.BoxView,s=t.FrameView,l=t.InnerFrameView,u=t.ManagerView,p=t.ModalDialogView,b=n.TenantWorkflows,w=n.TenantWorkflow,g=n.TenantNodes,v=n.TenantNode,h=n.Node,m=n.TenantLinks,y=n.TenantLink,C=function(t){function n(){return T=n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.initialize=function(t){n.__super__.initialize.call(this,t),this.editor=new E({el:"#workflow_editor",parent:this}),this.manager=new z({el:"#workflow_manager",parent:this})},n.prototype.open=function(t){switch(t){case"new":console.log("show workflow editor with create mode"),this.switchTo(this.manager);break;case"mgr":console.log("show workflow mgr"),this.switchTo(this.manager);break;default:t?(console.log("show workflow editor for",t),this.switchTo(this.editor),this.editor.load(t)):this.manager.rendered||this.switchTo(this.manager)}},n}(s),E=function(t){function n(){return V=n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.initialize=function(t){n.__super__.initialize.call(this,t),this.view=new L({el:N("#workflow_view",this.el),nodeEditor:new d,linkEditor:new a}),this.nodeList=new f({el:N("#node_list",this.el),workflowView:this.view})},n.prototype.load=function(t){var e=this;this.fetch(t,function(t,n){return n?e.view.load(n):e.view.clear()})},n.prototype.render=function(){return this.nodeList.render(),this},n.prototype.fetch=function(t,e){var n;n=this.workflow=new w({id:t}),n.fetch({success:function(){S.parallel([function(t){return n.nodes.fetch({success:function(e){return t(null,e)},error:function(){return t("fetch nodes failed")}})},function(t){return n.links.fetch({success:function(e){return t(null,e)},error:function(){return t("fetch links failed")}})}],function(t){t?(console.error(t),"function"==typeof e&&e(t)):(console.log("workflow",n),"function"==typeof e&&e(null,n))})}})},n}(l),f=function(t){function n(){return M=n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.initialize=function(t){var e=this;return n.__super__.initialize.call(this,t),this.workflowView=t.workflowView,this.el.onclick=function(t){var n;n=t.target,"A"===n.tagName&&n.dataset.node&&(t.preventDefault(),e.workflowView.addNode(n.dataset.node))}},n.prototype.render=function(){var t;return this.el.innerHTML="",t=document.createDocumentFragment(),t.appendChild(this.renderHeader("Common Nodes")),t.appendChild(this.renderItem("common",new h({id:"new",name:"Empty Node"}))),t.appendChild(this.renderHeader("Shared Nodes")),this.el.appendChild(t),this},n.prototype.renderHeader=function(t){var e;return e=document.createElement("li"),e.className="nav-header",e.innerHTML=t,e},n.prototype.renderItem=function(t,e){var n,i;return i=document.createElement("li"),n=document.createElement("a"),n.className="node",n.href="#node:"+e.id,n.dataset.list=t,n.dataset.node=e.id,n.innerHTML=e.get("name"),i.appendChild(n),i},n}(k),z=function(t){function n(){return j=n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.collection=new b,n}(u),r=function(t){function n(){return D=n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.events={"click button.btn-save":"save"},n.prototype.initialize=function(t){n.__super__.initialize.call(this,t),this.form=N("form",this.el)},n.prototype.popup=function(t,e){n.__super__.popup.call(this,t,e),this.fill(t)},n.prototype.fill=function(t){var e,n,i,o;this._attributes={},o=t.attributes;for(n in o)i=o[n],e=this.form[n],(null!=e?e.name:void 0)===n&&null!=e.value&&(e.value=i,this._attributes[n]=i)},n.prototype.save=function(){var t,e,n,i;if(null!=this._attributes){i=this._attributes;for(e in i)n=i[e],t=this.form[e],t.value!==n&&(this._attributes[e]=t.value),this.data.set(this._attributes)}this.callback("save"),this.hide(!0)},n.prototype.reset=function(){n.__super__.reset.call(this),this.form.reset()},n}(p),d=function(t){function n(){return B=n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.el="#node_editor",n.prototype.events={"click button.btn-save":"save","click a.action-thumb":"_addAction"},n.prototype.initialize=function(t){var e;n.__super__.initialize.call(this,t),this.actions=[],this.actionViews=[],this.actionsEl=N("#actions",this.el),e=this._fixStyle.bind(this),$(window).resize(e),$(this.el).on("shown",e),$(this.actionsEl).sortable({delay:150,distance:15})},n.prototype._fixStyle=function(){this.actionsEl.style.top=20+$(this.form).height()+"px"},n.prototype._addAction=function(t){var e,n;return t.preventDefault(),n=t.target,e=n.href.match(/action:(\w+)/i),e&&this.addAction({type:e[1]}),!1},n.prototype.fill=function(t){n.__super__.fill.call(this,t),[{type:"post_to_multi_social_media"},{type:"send_email"}].forEach(this.addAction.bind(this))},n.prototype.save=function(){console.log("save"),n.__super__.save.call(this)},n.prototype.reset=function(){n.__super__.reset.call(this),this.actions=[],this.actionViews=[],this.actionsEl.innerHTML=""},n.prototype.addAction=function(t){var e;return e=new i({model:t,parent:this,container:this.actionsEl}),e.on("close",this.removeAction.bind(this)),e.render(),this.actions.push(t),this.actionViews.push(e),e},n.prototype.removeAction=function(t,e){var n;n=this.actions.indexOf(e),0>n||(this.actions.splice(n,1),this.actionViews.splice(n,1))},n}(r),i=function(t){function n(){return F=n.__super__.constructor.apply(this,arguments)}return e(n,t),n.tpl=function(t){var e,n;if(null!=this._tpl&&null!=this._tpl[t])return this._tpl[t];if(e=N("#t_"+t),null==e)throw"cannot find template for type: "+t;return null==this._tpl&&(this._tpl={}),n=this._tpl[t]=e.innerHTML,e.parentNode.removeChild(e),n},n.prototype.className="box action",n.prototype.initialize=function(t){if(n.__super__.initialize.call(this,t),this.containerEl=t.container,this.model=t.model,this.type=t.model.type||t.type,!this.model||!this.type)throw"need action model and type"},n.prototype.close=function(){var t;this.el.parentNode.removeChild(this.el),t=this.model,this.trigger("close",this,t),t.type=null,t.name=null,t.data=null},n.prototype.render=function(){var t,e;return t=this.constructor.tpl(this.type),this.containerEl.appendChild(this.el),this.el.innerHTML=t,n.__super__.render.call(this),/webkit/i.test(navigator.userAgent)?$(this.el).disableSelection():$(".box-header, .btn",this.el).disableSelection(),this.form=N("form",this.el),this.fill(null!=(e=this.model)?e.data:void 0),this},n.prototype.fill=function(t){var e,n,i,o;if(t&&this.form){n=this.form;for(i in t)o=t[i],e=n[i],(null!=e?e.getAttribute("name"):void 0)===i&&$(e).val(o)}},n.prototype.read=function(t){var e;if(!this.form)throw"cannot find the form, may not rendered yet";return null==t&&(t={}),e=[].slice.call(this.form.elements),e.forEach(function(e){var n,i;return n=$(e),i=n.attr("name"),i?t[i]=n.val():void 0}),t},n}(o),a=function(t){function n(){return I=n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.el="#link_editor",n.prototype.initialize=function(t){n.__super__.initialize.call(this,t)},n.prototype.popup=function(t,e){n.__super__.popup.call(this,t,e)},n}(r),L=function(t){function n(){return O=n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.jsPlumbDefaults={DragOptions:{zIndex:2e3},Endpoint:["Dot",{radius:3,cssClass:"endpoint"}],ConnectionsDetachable:!0,ReattachConnections:!0,HoverPaintStyle:{strokeStyle:"#42a62c",lineWidth:2,zIndex:2e3},Connector:["Flowchart",{stub:[40,60],gap:10,cssClass:"link"}],ConnectionOverlays:[["Arrow",{location:1,id:"arrow"}],["Label",{location:.5,label:"new link",id:"label",cssClass:"link-label"}]]},n.prototype.gridDefaults={padding:30,spanX:300,spanY:150,vertical:!1},n.prototype.events={"click .popover .btn-delete":"_delete","click .popover .btn-edit":"_edit","dblclick .node":"_edit"},n.prototype.initialize=function(t){n.__super__.initialize.call(this,t),this.nodeEditor=t.nodeEditor,this.linkEditor=t.linkEditor,jsPlumb.importDefaults(this.jsPlumbDefaults),this.render()},n.prototype._bind=function(){var t,e,n;t=this,jsPlumb.bind("jsPlumbConnection",function(t){var e,n,i;e=t.connection,i=e.getParameter("link"),n=e.getOverlay("label"),null==i||i.has("title")&&n.setLabel(i.get("title"))}),jsPlumb.bind("jsPlumbConnectionDetached",function(t){var e,n;e=t.connection,n=e.getParameter("link"),n.prevNode.view.buildSrcEndpoint()}),jsPlumb.bind("dblclick",function(e){t.editLink(e.getParameter("link"))}),e=function(){t._popped&&(t._popped._delay?t._popped._delay=clearTimeout(t._popped._delay):$(t._popped).popover("hide"))},n=function(){var n=this;t._popped===this||this._hidding?(e(),t._popped=null):(this._delay=setTimeout(function(){return(t._popped=n)&&$(n).popover("show"),n._delay=null},100),t._popped=this)},jsPlumb.bind("click",function(t){var e;e=t.getOverlay("label"),n.call(e.canvas)}),this.$el.on("click",".node",n),this.$el.on("mousedown",function(n){var i;t._popped&&!t.$el.find(".popover").has(n.target).length&&(e(),i=t._popped,t._popped=null,i._hidding=!0,setTimeout(function(){return delete i._hidding},300))})},n.prototype.clear=function(){return this.el.innerHTML="",this},n.prototype.load=function(t){return this.clear(),this._processModel(t),this._renderModel(t),this},n.prototype._action=function(t,e){var n,i,o;if(n=$(e.target),n.hasClass("target")||(n=n.parents(".target")),o=n.data("node"))i=this[t+"Node"];else{if(!(o=n.data("link")))return console.error("no node or link in data",n,e),void 0;i=this[t+"Link"]}null!=i&&i.call(this,o)},n.prototype._delete=function(t){this._action("remove",t)},n.prototype._edit=function(t){this._action("edit",t)},n.prototype._processModel=function(t){var e;this.model=t,t.nodes.forEach(function(e){e.workflow=t,e.inLinks=[],e.outLinks=[]}),t.links.forEach(function(e){e.workflow=t,e.prevNode=t.nodes.get(e.get("prevNodeId")),e.nextNode=t.nodes.get(e.get("nextNodeId")),e.prevNode&&e.nextNode||console.error("link",e.name||e.id,"is broken, prev/next node missing"),e.prevNode.outLinks.push(e),e.nextNode.inLinks.push(e)}),e=t.nodes,e.lonely=[],e.start=[],e.end=[],e.forEach(function(t){var n;t.inLinks.length===(n=t.outLinks.length)&&0===n?e.lonely.push(t):0===t.inLinks.length?e.start.push(t):0===t.outLinks.length&&e.end.push(t)}),this._sortNodeViews(e)},n.prototype._sortNodeViews=function(t){var e,n,i,o,r,s,l;e=this.grid=[t.start.concat(t.lonely)],l=this.gridDefaults,s=l.vertical,n=l.padding,i=l.spanX,o=l.spanY,(r=function(t){var l,a;l=[],null!=(a=e[t])&&a.forEach(function(e,r){var a;e.gridX=r,e.gridY=t,s?(e.x=r*i,e.y=t*o):(e.x=t*i,e.y=r*o),e.x+=n,e.y+=n,null!=(a=e.outLinks)&&a.forEach(function(t){null==t.nextNode.gridX&&l.push(t.nextNode)})}),l.length&&(e[t+1]=l,r(t+1))})(0),console.log("grid",e)},n.prototype._renderModel=function(t){var e=this;if(console.log("render wf",t),t=this.model,null==t)throw"workflow not loaded";this._bind(),t.nodes.forEach(function(t){e._addNode(t)}),t.links.forEach(function(t){e._addLink(t)})},n.prototype.addNode=function(t){if(null==t&&(t="emtpy"),"new"===t||"empty"===t)return console.log("add a empty node"),this.createNode();if("string"==typeof t)console.log("add node by id",t);else if(!(t instanceof h))throw console.error("add a invalid node",t),"add a invalid node";return console.log("add node",t),this._addNode(t),this},n.prototype._addNode=function(t){var e;e=t.view=new _({model:t,parent:this}),e.render(),this.el.appendChild(e.el)},n.prototype.createNode=function(){var t=this;return this.nodeEditor.popup(new v,function(e,n){return"save"===e?t._addNode(n):console.log("canceled create node")}),this},n.prototype.editNode=function(t){return this.nodeEditor.popup(t,function(t,e){return"save"===t?(e.view.update(e),console.log("saved node",e)):console.log("canceled edit node")}),this},n.prototype.removeNode=function(t){var e;return confirm("Delete the node: "+t.get("title")+"?")&&(console.log("remove node",t),null!=(e=t.view)&&e.distory()),this},n.prototype.addLink=function(){return this},n.prototype._addLink=function(t){var e;e=t.view=new c({model:t,parent:this}),e.render()},n.prototype.editLink=function(t){return this.linkEditor.popup(t,function(t,e){return"save"===t?console.log("saved link",e):console.log("canceled edit link")}),this},n.prototype.removeLink=function(t){var e;return confirm("Delete the link: "+(t.get("title")||"(No Name)")+"?")&&(console.log("remove node",t),null!=(e=t.view)&&e.distory()),this},n.prototype.render=function(){return this.el.onselectstart=function(){return!1},this},n}(k),_=function(t){function n(){return H=n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.tagName="div",n.prototype.className="node",n.prototype.sourceEndpointStyle={isSource:!0,uniqueEndpoint:!0,anchor:"RightMiddle",paintStyle:{fillStyle:"#225588",radius:9},connectorStyle:{strokeStyle:"#346789",lineWidth:2,outlineColor:"#fff",outlineWidth:1},connectorHoverStyle:{strokeStyle:"#42a62c",outlineWidth:2},maxConnections:-1},n.prototype.targetEndpointStyle={isTarget:!0,anchor:["LeftMiddle","BottomCenter"],paintStyle:{fillStyle:"#225588",radius:5},dropOptions:{hoverClass:"hover",activeClass:"active"}},n.prototype._popover_tpl=function(){var t,e;if(t=N("#t_popover"),null==t)throw"cannot find template for popover #t_popover";return e=t.innerHTML,t.parentNode.removeChild(t),e}(),n.prototype.render=function(){var t,e;return e=this.el.node=this.model,t=this.el.id=e.get("name"),this._renderModel(e),jsPlumb.draggable(this.$el),this.parentEl.appendChild(this.el),this.buildSrcEndpoint(),jsPlumb.makeTarget(this.$el,this.targetEndpointStyle,{parameters:{node:e,view:this}}),this},n.prototype.update=function(t){return null==t&&(t=this.model),this.$el.popover("destroy"),this._renderModel(t),jsPlumb.repaint(this.el.id),this},n.prototype._renderModel=function(t){var e,n;null==t&&(t=this.model),this.el.innerHTML=t.escape("title"),e=this.el.title=t.get("title"),this.el.style.left=t.x+"px",this.el.style.top=t.y+"px",this.$el.addClass("target").data({node:t,view:this}),this.$el.popover({container:this.parentEl,trigger:"manual",placement:"bottom",title:e,html:!0,content:this._popover_tpl.replace("{desc}",t.get("desc")||"")}),this.$popover=this.$el.data("popover").tip(),null!=(n=this.$popover)&&n.addClass("target").data({node:t,view:this})},n.prototype.buildSrcEndpoint=function(){return null!=this.srcEndpoint&&jsPlumb.deleteEndpoint(this.srcEndpoint),this.srcEndpoint=jsPlumb.addEndpoint(this.el,this.sourceEndpointStyle,{parameters:{model:this.model,view:this}}),this},n.prototype.distory=function(){this.$el.popover("destroy"),this.trigger("distory",this,this.model)},n}(k),c=function(t){function n(){return P=n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype._popover_tpl=_.prototype._popover_tpl,n.prototype.render=function(){var t,e,n,i,o;return n=this.model,n.view=this,t=this.conn=jsPlumb.connect({source:n.prevNode.view.srcEndpoint,target:n.nextNode.view.el,cssClass:"link",hoverClass:"hover",parameters:{link:n,view:this}}),this.setElement(t.canvas),this.label=t.getOverlay("label"),this.labelEl=this.label.canvas,i=n.get("title"),e=$(this.labelEl),i?this.labelEl.title="Link: "+i:(e.css("visibility","hidden"),this.labelEl.title="Link"),e.popover({container:this.parentEl,trigger:"manual",placement:"bottom",html:!0,content:this._popover_tpl.replace("{desc}",n.get("desc")||"")}),this.$popover=e.data("popover").tip(),null!=(o=this.$popover)&&o.addClass("target").data({link:n,view:this}),this},n.prototype.distory=function(){jsPlumb.detach(this.conn),$(this.labelEl).popover("destroy"),this.trigger("distory",this,this.model)},n}(k),C})}.call(this);
