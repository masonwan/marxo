(function(){"use strict";var t={}.hasOwnProperty,e=function(e,n){function i(){this.constructor=e}for(var o in n)t.call(n,o)&&(e[o]=n[o]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};define("workflow",["console","workflow_models","lib/jquery-ui","lib/jquery-jsplumb"],function(t,n){var i,o,r,s,l,a,u,c,p,h,d,f,_,y,m,v,w,g,b,k,E,L,z,N,S,T,C,P,x,V,j,M,I,O;return L=t.async,z=t.find,N=t.findAll,w=t.View,o=t.FrameView,r=t.InnerFrameView,a=t.ModalDialogView,v=n.TenantWorkflows,m=n.TenantWorkflow,y=n.TenantNodes,_=n.TenantNode,u=n.Node,f=n.TenantLinks,d=n.TenantLink,b=function(t){function n(){return S=n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.initialize=function(t){n.__super__.initialize.call(this,t),this.editor=new g({el:"#workflow_editor",parent:this}),this.manager=new k({el:"#workflow_manager",parent:this})},n.prototype.open=function(t){"new"===t?(console.log("show workflow editor with create mode"),this.switchTo(this.manager)):"mgr"===t?(console.log("show workflow mgr"),this.switchTo(this.manager)):t&&(console.log("show workflow editor for",t),this.switchTo(this.editor),this.editor.load(t))},n}(o),g=function(t){function n(){return T=n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.initialize=function(t){n.__super__.initialize.call(this,t),this.view=new E({el:z("#workflow_view",this.el),nodeEditor:new c,linkEditor:new s}),this.nodeList=new p({el:z("#node_list",this.el),workflowView:this.view})},n.prototype.load=function(t){var e=this;this.fetch(t,function(t,n){return n?e.view.load(n):e.view.clear()})},n.prototype.render=function(){this.nodeList.render()},n.prototype.fetch=function(t,e){var n;n=this.workflow=new m({id:t}),n.fetch({success:function(){L.parallel([function(t){return n.nodes.fetch({success:function(e){return t(null,e)},error:function(){return t("fetch nodes failed")}})},function(t){return n.links.fetch({success:function(e){return t(null,e)},error:function(){return t("fetch links failed")}})}],function(t){t?(console.error(t),"function"==typeof e&&e(t)):(console.log("workflow",n),"function"==typeof e&&e(null,n))})}})},n}(r),p=function(t){function n(){return C=n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.initialize=function(t){var e=this;return n.__super__.initialize.call(this,t),this.workflowView=t.workflowView,this.el.onclick=function(t){var n;n=t.target,n.tagName==="A"&&n.dataset.node&&(t.preventDefault(),e.workflowView.addNode(n.dataset.node))}},n.prototype.render=function(){var t;return this.el.innerHTML="",t=document.createDocumentFragment(),t.appendChild(this.renderHeader("Common Nodes")),t.appendChild(this.renderItem("common",new u({id:"new",name:"Empty Node"}))),t.appendChild(this.renderHeader("Shared Nodes")),this.el.appendChild(t),this},n.prototype.renderHeader=function(t){var e;return e=document.createElement("li"),e.className="nav-header",e.innerHTML=t,e},n.prototype.renderItem=function(t,e){var n,i;return i=document.createElement("li"),n=document.createElement("a"),n.className="node",n.href="#node:"+e.id,n.dataset.list=t,n.dataset.node=e.id,n.innerHTML=e.get("name"),i.appendChild(n),i},n}(w),k=function(t){function n(){return P=n.__super__.constructor.apply(this,arguments)}return e(n,t),n}(r),i=function(t){function n(){return x=n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.initialize=function(t){n.__super__.initialize.call(this,t),this.form=z("form",this.el)},n.prototype.popup=function(t,e){return n.__super__.popup.call(this,t,e),this.fill(t),this},n.prototype.fill=function(t){var e,n,i,o;this._attributes={},o=t.attributes;for(n in o)i=o[n],e=this.form[n],(null!=e?e.name:void 0)===n&&e.value!=null&&(e.value=i,this._attributes[n]=i);return this},n.prototype.save=function(){var t,e,n,i;if(this._attributes!=null){i=this._attributes;for(e in i)n=i[e],t=this.form[e],t.value!==n&&(this._attributes[e]=t.value),this.data.set(this._attributes)}return this.callback("save"),this.hide(!0)},n}(a),c=function(t){function n(){return V=n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.el="#node_editor",n.prototype.initialize=function(t){var e;n.__super__.initialize.call(this,t),this.actionsEl=z("#actions",this.el),e=this._fixStyle.bind(this),$(window).resize(e),$(this.el).on("shown",e)},n.prototype._fixStyle=function(){this.actionsEl.style.top=20+$(this.form).height()+"px"},n}(i),s=function(t){function n(){return j=n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.el="#link_editor",n.prototype.initialize=function(t){n.__super__.initialize.call(this,t)},n.prototype.popup=function(t,e){return n.__super__.popup.call(this,t,e),this},n}(i),E=function(t){function n(){return M=n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.jsPlumbDefaults={DragOptions:{zIndex:2e3},Endpoint:["Dot",{radius:3,cssClass:"endpoint"}],ConnectionsDetachable:!0,ReattachConnections:!0,HoverPaintStyle:{strokeStyle:"#42a62c",lineWidth:2,zIndex:2e3},Connector:["Flowchart",{stub:[40,60],gap:10,cssClass:"link"}],ConnectionOverlays:[["Arrow",{location:1,id:"arrow"}],["Label",{location:.5,label:"new link",id:"label",cssClass:"link-label"}]]},n.prototype.gridDefaults={padding:30,spanX:300,spanY:150,vertical:!1},n.prototype.initialize=function(t){n.__super__.initialize.call(this,t),this.nodeEditor=t.nodeEditor,this.linkEditor=t.linkEditor,jsPlumb.importDefaults(this.jsPlumbDefaults),this.render()},n.prototype._bind=function(){var t,e,n;t=this,jsPlumb.bind("jsPlumbConnection",function(t){var e,n,i;e=t.connection,i=e.getParameter("link"),n=e.getOverlay("label"),null==i||i.has("title")&&n.setLabel(i.get("title"))}),jsPlumb.bind("jsPlumbConnectionDetached",function(t){var e,n;e=t.connection,n=e.getParameter("link"),n.prevNode.view.buildSrcEndpoint()}),e=function(){t._popped&&(t._popped._delay?t._popped._delay=clearTimeout(t._popped._delay):$(t._popped).popover("hide"))},n=function(){var n=this;t._popped===this||this._hidding?(e(),t._popped=null):(this._delay=setTimeout(function(){return(t._popped=n)&&$(n).popover("show"),n._delay=null},100),t._popped=this)},jsPlumb.bind("click",function(t){var e;e=t.getOverlay("label"),n.call(e.canvas)}),jsPlumb.bind("dblclick",function(e){t.editLink(e.getParameter("link"))}),this.$el.on("click",".node",n),this.$el.on("dblclick",".node",function(){t.editNode(this.node)}),this.$el.on("mousedown",function(n){var i;t._popped&&!t.$el.find(".popover").has(n.target).length&&(e(),i=t._popped,t._popped=null,i._hidding=!0,setTimeout(function(){return delete i._hidding},300))})},n.prototype.clear=function(){return this.el.innerHTML="",this},n.prototype.load=function(t){return this.clear(),this._processModel(t),this._renderModel(t),this},n.prototype._processModel=function(t){var e;this.model=t,t.nodes.forEach(function(e){e.workflow=t,e.inLinks=[],e.outLinks=[]}),t.links.forEach(function(e){e.workflow=t,e.prevNode=t.nodes.get(e.get("prevNodeId")),e.nextNode=t.nodes.get(e.get("nextNodeId")),e.prevNode&&e.nextNode||console.error("link",e.name||e.id,"is broken, prev/next node missing"),e.prevNode.outLinks.push(e),e.nextNode.inLinks.push(e)}),e=t.nodes,e.lonely=[],e.start=[],e.end=[],e.forEach(function(t){var n;t.inLinks.length===(n=t.outLinks.length)&&0===n?e.lonely.push(t):t.inLinks.length===0?e.start.push(t):t.outLinks.length===0&&e.end.push(t)}),this._sortNodeViews(e)},n.prototype._sortNodeViews=function(t){var e,n,i,o,r,s,l;e=this.grid=[t.start.concat(t.lonely)],l=this.gridDefaults,s=l.vertical,n=l.padding,i=l.spanX,o=l.spanY,(r=function(t){var l,a;l=[],(a=e[t])!=null&&a.forEach(function(e,r){var a;e.gridX=r,e.gridY=t,s?(e.x=r*i,e.y=t*o):(e.x=t*i,e.y=r*o),e.x+=n,e.y+=n,(a=e.outLinks)!=null&&a.forEach(function(t){t.nextNode.gridX==null&&l.push(t.nextNode)})}),l.length&&(e[t+1]=l,r(t+1))})(0),console.log("grid",e)},n.prototype._renderModel=function(t){var e=this;if(console.log("render wf",t),t=this.model,null==t)throw"workflow not loaded";this._bind(),t.nodes.forEach(function(t){e._addNode(t)}),t.links.forEach(function(t){e._addLink(t)})},n.prototype.addNode=function(t){if(null==t&&(t="emtpy"),"new"===t||"empty"===t)return console.log("add a empty node"),this.createNode();if("string"==typeof t)console.log("add node by id",t);else if(!(t instanceof u))throw console.error("add a invalid node",t),"add a invalid node";return console.log("add node",t),this._addNode(t),this},n.prototype._addNode=function(t){var e;e=t.view=new h({model:t,parent:this}),e.render(),this.el.appendChild(e.el)},n.prototype.createNode=function(){var t=this;return this.nodeEditor.popup(new _,function(e,n){return"save"===e?t._addNode(n):console.log("canceled create node")}),this},n.prototype.editNode=function(t){return this.nodeEditor.popup(t,function(t,e){return"save"===t?(e.view.update(e),console.log("saved node",e)):console.log("canceled edit node")}),this},n.prototype.removeNode=function(){return this},n.prototype.addLink=function(){return this},n.prototype._addLink=function(t){var e;e=t.view=new l({model:t,parent:this}),e.render()},n.prototype.editLink=function(t){return this.linkEditor.popup(t,function(t,e){return"save"===t?console.log("saved link",e):console.log("canceled edit link")}),this},n.prototype.removeLink=function(){return this},n.prototype.render=function(){return this.el.onselectstart=function(){return!1},this},n}(w),h=function(t){function n(){return I=n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.tagName="div",n.prototype.className="node",n.prototype.sourceEndpointStyle={isSource:!0,uniqueEndpoint:!0,anchor:"RightMiddle",paintStyle:{fillStyle:"#225588",radius:9},connectorStyle:{strokeStyle:"#346789",lineWidth:2,outlineColor:"#fff",outlineWidth:1},connectorHoverStyle:{strokeStyle:"#42a62c",outlineWidth:2},maxConnections:-1},n.prototype.targetEndpointStyle={isTarget:!0,anchor:["LeftMiddle","BottomCenter"],paintStyle:{fillStyle:"#225588",radius:5},dropOptions:{hoverClass:"hover",activeClass:"active"}},n.prototype.render=function(){var t,e;return e=this.el.node=this.model,t=this.el.id=e.get("name"),this._renderModel(e),jsPlumb.draggable(this.$el),this.parentEl.appendChild(this.el),this.buildSrcEndpoint(),jsPlumb.makeTarget(this.$el,this.targetEndpointStyle,{parameters:{node:e,view:this}})},n.prototype.update=function(t){return null==t&&(t=this.model),this.$el.popover("destroy"),this._renderModel(t),jsPlumb.repaint(this.el.id),this},n.prototype._renderModel=function(t){var e;null==t&&(t=this.model),this.el.innerHTML=t.escape("title"),e=this.el.title=t.get("title"),this.el.style.left=t.x+"px",this.el.style.top=t.y+"px",this.$el.popover({container:this.parentEl,trigger:"manual",placement:"bottom",title:e})},n.prototype.buildSrcEndpoint=function(){return this.srcEndpoint!=null&&jsPlumb.deleteEndpoint(this.srcEndpoint),this.srcEndpoint=jsPlumb.addEndpoint(this.el,this.sourceEndpointStyle,{parameters:{model:this.model,view:this}}),this},n}(w),l=function(t){function n(){return O=n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.render=function(){var t,e,n,i;return n=this.model,t=this.conn=jsPlumb.connect({source:n.prevNode.view.srcEndpoint,target:n.nextNode.view.el,cssClass:"link",hoverClass:"hover",parameters:{link:n,view:this}}),this.setElement(t.canvas),this.label=t.getOverlay("label"),this.labelEl=this.label.canvas,i=n.get("title"),e=$(this.labelEl),i?this.labelEl.title="Link: "+i:(e.css("visibility","hidden"),this.labelEl.title="Link"),e.popover({container:this.parentEl,trigger:"manual",placement:"bottom"}),this},n}(w),b})}).call(this);
