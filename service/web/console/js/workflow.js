(function(){"use strict";var t={}.hasOwnProperty,e=function(e,n){function i(){this.constructor=e}for(var o in n)t.call(n,o)&&(e[o]=n[o]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};define("workflow",["console","workflow_models","lib/jquery-ui","lib/jquery-jsplumb"],function(t,n){var i,o,r,s,l,a,u,c,p,h,d,f,y,_,v,g,m,w;return y=t.async,_=t.find,h=t.View,i=t.FrameView,p=n.TenantWorkflows,c=n.TenantWorkflow,u=n.TenantNodes,a=n.TenantNode,l=n.TenantLinks,s=n.TenantLink,d=function(t){function n(){return v=n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.initialize=function(t){n.__super__.initialize.call(this,t),this.view=new f({parent:this,el:_("#workflow_view",this.el)})},n}(i),f=function(t){function n(){return g=n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.jsPlumbDefaults={DragOptions:{zIndex:2e3},Endpoint:["Dot",{radius:3,cssClass:"endpoint"}],ConnectionsDetachable:!0,ReattachConnections:!0,HoverPaintStyle:{strokeStyle:"#42a62c",lineWidth:2,zIndex:2e3},Connector:["Flowchart",{stub:[40,60],gap:10,cssClass:"link"}],ConnectionOverlays:[["Arrow",{location:1,id:"arrow"}],["Label",{location:.5,label:"new link",id:"label",cssClass:"link-label"}]]},n.prototype.gridDefaults={padding:30,spanX:300,spanY:150,vertical:!1},n.prototype.initialize=function(t){n.__super__.initialize.call(this,t),jsPlumb.importDefaults(this.jsPlumbDefaults),this._loadModel()},n.prototype._bind=function(){var t,e;jsPlumb.bind("jsPlumbConnection",function(t){var e,n,i;e=t.connection,i=e.getParameter("link"),n=e.getOverlay("label"),null==i||i.has("title")&&n.setLabel(i.get("title"))}),jsPlumb.bind("jsPlumbConnectionDetached",function(t){var e,n;e=t.connection,n=e.getParameter("link"),n.prevNode.view.buildSrcEndpoint()}),t=this,e=function(){t._popped&&$(t._popped).popover("hide"),t._popped===this||this._hidding?t._popped=null:($(this).popover("show"),t._popped=this)},jsPlumb.bind("click",function(t){var n;n=t.getOverlay("label"),e.call(n.canvas)}),this.$el.on("click",".node",e),this.$el.on("mousedown",function(e){var n;t._popped&&!t.$el.find(".popover").has(e.target).length&&($(t._popped).popover("hide"),n=t._popped,t._popped=null,n._hidding=!0,setTimeout(function(){return delete n._hidding},300))})},n.prototype._loadModel=function(t){var e,n=this;null==t&&(t=this.render),e=this.model=new c({id:"51447afb4728cb2036cf9ca1"}),e.fetch({success:function(){y.parallel([function(t){return e.nodes.fetch({success:function(e){return t(null,e)},error:function(){return t("fetch nodes failed")}})},function(t){return e.links.fetch({success:function(e){return t(null,e)},error:function(){return t("fetch links failed")}})}],function(i){var o;return i?(console.error(i),void 0):(console.log("workflow",e),e.nodes.forEach(function(t){t.workflow=e,t.inLinks=[],t.outLinks=[]}),e.links.forEach(function(t){t.workflow=e,t.prevNode=e.nodes.get(t.get("prevNodeId")),t.nextNode=e.nodes.get(t.get("nextNodeId")),t.prevNode&&t.nextNode||console.error("link",t.name||t.id,"is broken, prev/next node missing"),t.prevNode.outLinks.push(t),t.nextNode.inLinks.push(t)}),o=e.nodes,o.lonely=[],o.start=[],o.end=[],o.forEach(function(t){var e;t.inLinks.length===(e=t.outLinks.length)&&0===e?o.lonely.push(t):0===t.inLinks.length?o.start.push(t):0===t.outLinks.length&&o.end.push(t)}),n._sortNodeViews(o),t.call(n,e))})}})},n.prototype._sortNodeViews=function(t){var e,n,i,o,r,s,l;e=this.grid=[t.start.concat(t.lonely)],l=this.gridDefaults,s=l.vertical,n=l.padding,i=l.spanX,o=l.spanY,(r=function(t){var l,a;l=[],null!=(a=e[t])&&a.forEach(function(e,r){var a;e.gridX=r,e.gridY=t,s?(e.x=r*i,e.y=t*o):(e.x=t*i,e.y=r*o),e.x+=n,e.y+=n,null!=(a=e.outLinks)&&a.forEach(function(t){null==t.nextNode.gridX&&l.push(t.nextNode)})}),l.length&&(e[t+1]=l,r(t+1))})(0),console.log("grid",e)},n.prototype.addNode=function(){return this},n.prototype.removeNode=function(){return this},n.prototype.addLink=function(){return this},n.prototype.removeLink=function(){return this},n.prototype.render=function(){var t,e=this;if(console.log("render wf"),this.el.onselectstart=function(){return!1},t=this.model,null==t)throw"workflow not loaded";return this._bind(),t.nodes.forEach(function(t){var n;n=t.view=new r({model:t,parent:e}),n.render(),e.el.appendChild(n.el)}),t.links.forEach(function(t){var n;return n=t.view=new o({model:t,parent:e}),n.render()}),this},n}(h),r=function(t){function n(){return m=n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.tagName="div",n.prototype.className="node",n.prototype.sourceEndpointStyle={isSource:!0,uniqueEndpoint:!0,anchor:"RightMiddle",paintStyle:{fillStyle:"#225588",radius:9},connectorStyle:{strokeStyle:"#346789",lineWidth:2,outlineColor:"#fff",outlineWidth:1},connectorHoverStyle:{strokeStyle:"#42a62c",outlineWidth:2},maxConnections:-1},n.prototype.targetEndpointStyle={isTarget:!0,anchor:["LeftMiddle","BottomCenter"],paintStyle:{fillStyle:"#225588",radius:5},dropOptions:{hoverClass:"hover",activeClass:"active"}},n.prototype.render=function(){var t,e;return e=this.model,t=this.el.id=e.get("name"),this.el.innerHTML=e.escape("title"),this.el.title=e.get("title"),this.el.style.left=e.x+"px",this.el.style.top=e.y+"px",jsPlumb.draggable(this.$el),this.parentEl.appendChild(this.el),this.buildSrcEndpoint(),jsPlumb.makeTarget(this.$el,this.targetEndpointStyle,{parameters:{node:e,view:this}}),this.$el.popover({container:this.parentEl,trigger:"manual",placement:"bottom"}),this},n.prototype.buildSrcEndpoint=function(){return null!=this.srcEndpoint&&jsPlumb.deleteEndpoint(this.srcEndpoint),this.srcEndpoint=jsPlumb.addEndpoint(this.el,this.sourceEndpointStyle,{parameters:{model:this.model,view:this}}),this},n}(h),o=function(t){function n(){return w=n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.render=function(){var t,e,n,i;return n=this.model,t=this.conn=jsPlumb.connect({source:n.prevNode.view.srcEndpoint,target:n.nextNode.view.el,cssClass:"link",hoverClass:"hover",parameters:{link:n,view:this}}),this.setElement(t.canvas),this.label=t.getOverlay("label"),this.labelEl=this.label.canvas,i=n.get("title"),e=$(this.labelEl),i?this.labelEl.title="Link: "+i:(e.css("visibility","hidden"),this.labelEl.title="Link"),e.popover({container:this.parentEl,trigger:"manual",placement:"bottom"}),this},n}(h),d})}).call(this);
